---
layout: post
title: Retrieving custom user attributes from LDAP in WebSphere
category: tech
---

WebSphere can be configured to use LDAP as authentication mechanism. The implementation is fairly complete and has support for SSL, connection reuse, multiple LDAP servers with failover as well as mapping of client certificates to LDAP users. However, in many use cases applications also need access to additional LDAP attributes (such as the email address or employee ID of the authenticated user).<br />
<br />
An obvious approach to get access to these attributes would be to make use of the <span style="font-family: Courier New, Courier, monospace;">javax.naming.ldap</span> API (or an equivalent API) inside the application or to write a custom JAAS login module that performs the lookup using that API and adds the information to the <span style="font-family: Courier New, Courier, monospace;">Subject</span> (from where they are retrieved by the application). However, this approach would have several drawbacks:<br />
<ul>
<li>It leads to duplicate configuration because LDAP needs to be configured in WebSphere and the same configuration information also needs to be provided to the custom code.</li>
<li>The LDAP support in WebSphere maintains a pool of LDAP connections and correctly performs failover if it detects that the primary LDAP server becomes unavailable. The custom code cannot take advantage of these features and needs to manage its own set of LDAP connections.</li>
</ul>
Ideally, instead of interacting with LDAP directly, the custom code should perform the lookup via some API exposed by WebSphere in, so that it can reuse the existing LDAP client infrastructure (including connection pooling, SSL support, failover, etc.). Unfortunately this is not feasible if WebSphere is configured with a standalone LDAP registry as user registry. The reason is that although the user registry (of type <span style="font-family: Courier New, Courier, monospace;">com.ibm.ws.security.registry.ldap.LdapRegistryImpl</span> in that case) can be looked up via JNDI, there is no public API allowing to access additional LDAP attributes.<br />
<br />
However, LDAP can also be configured as a backend of a federated user repository. "Federated repositories" is one of the four user registry types supported by WebSphere, the other three being "Local operating system", "Standalone LDAP registry" and "Standalone custom registry". The "Federated repositories" implementation originally comes from WebSphere Portal Server and is also called VMM (Virtual Member Manager) or WIM (WebSphere Identity Manager). The main feature of this registry type is its ability to <a href="http://www.ibm.com/developerworks/websphere/techjournal/0701_ilechko/0701_ilechko.html">map entries from multiple individual user repositories into a single virtual repository</a>. It also exposes an API that gives access to additional user attributes. This is of course the feature we are looking for.<br />
<br />
Therefore a prerequisite to access custom LDAP attributes is to configure WebSphere security to use VMM instead of the standalone LDAP registry. All features (SSL, pooling, failover, etc.) supported by the standalone LDAP registry are also supported by VMM, and it is relatively straightforward to create a VMM configuration that is equivalent to an existing standalone LDAP registry configuration. In the following we will assume that this has been done and that VMM has been configured as the user registry implementation.<br />
<br />
We can now examine how to use the Virtual Member Manager API to get access to custom LDAP attributes. We assume that the code will be integrated into a custom JAAS login module, but the ingredients are the same if you want to integrate the code into your applications.<br />
<br />
The first step is to get access to the Virtual Member Manager API. That API is defined by the <a href="http://pic.dhe.ibm.com/infocenter/wasinfo/v7r0/topic/com.ibm.websphere.javadoc.vmm.doc/vmm/com/ibm/websphere/wim/Service.html"><span style="font-family: Courier New, Courier, monospace;">Service</span></a> interface. To get a reference to the VMM service in the local JVM, simply instantiate <a href="http://pic.dhe.ibm.com/infocenter/wasinfo/v7r0/topic/com.ibm.websphere.javadoc.vmm.doc/vmm/com/ibm/websphere/wim/client/LocalServiceProvider.html"><span style="font-family: Courier New, Courier, monospace;">LocalServiceProvider</span></a> with the default constructor:<br />
<br />
<span style="font-family: Courier New, Courier, monospace;">Service service = new LocalServiceProvider();</span><br />
<br />
The WebSphere infocenter document "<a href="http://pic.dhe.ibm.com/infocenter/wasinfo/v7r0/topic/com.ibm.websphere.wim.doc/gettingthepropertiesofanentity.html">Getting the properties of an entity</a>" describes how to use the <span style="font-family: Courier New, Courier, monospace;">Service</span> API to look up the attributes of a user. As you can see in that documentation, this operation requires as input the unique security name of the user, which looks as follows (Note that this is not necessarily identical to the DN of the user in LDAP):<br />
<br />
<span style="font-family: Courier New, Courier, monospace;">uid=SalesManager,cn=users,dc=yourco,dc=com</span><br />
<br />
This information can be retrieved from the <a href="http://pic.dhe.ibm.com/infocenter/wasinfo/v7r0/topic/com.ibm.websphere.javadoc.doc/web/apidocs/com/ibm/websphere/security/cred/WSCredential.html"><span style="font-family: Courier New, Courier, monospace;">WSCredential</span></a> object which is put by one of the WebSphere login modules into the shared state (i.e. the <span style="font-family: Courier New, Courier, monospace;">Map</span> that is passed to the initialize method of the <span style="font-family: Courier New, Courier, monospace;">LoginModule</span>). The key to get the object from the map is defined in <a href="http://pic.dhe.ibm.com/infocenter/wasinfo/v7r0/topic/com.ibm.websphere.javadoc.doc/web/spidocs/com/ibm/wsspi/security/auth/callback/Constants.html"><span style="font-family: Courier New, Courier, monospace;">Constants</span></a>. The unique security name is returned by the <span style="font-family: Courier New, Courier, monospace;">getUniqueSecurityName</span> method.<br />
<br />
The WebSphere infocenter document mentioned above shows how to specify the list of attributes to be retrieved. It is important to note that these are not LDAP attribute names but names of properties of the <span style="font-family: Courier New, Courier, monospace;">PersonAccount</span> entity defined by VMM. By default, if a property is defined in the <span style="font-family: Courier New, Courier, monospace;">PersonAccount</span>, then it is mapped to the LDAP attribute with the same name. This also means that in order to access an LDAP attribute, a corresponding property must be defined in the <span style="font-family: Courier New, Courier, monospace;">PersonAccount</span> entity. The WebSphere admin console doesn’t allow to inspect or edit the properties of an entity. Therefore this must be done with the help of wsadmin. To inspect the list of existing properties, use the following command:<br />
<br />
<span style="font-family: Courier New, Courier, monospace;">$AdminTask getIdMgrPropertySchema { -entityTypeName PersonAccount }</span><br />
<br />
You will see that the <span style="font-family: Courier New, Courier, monospace;">PersonAccount</span> already defines properties for many of the attributes typically used in LDAP. If you use custom attributes not defined in <span style="font-family: Courier New, Courier, monospace;">PersonAccount</span>, you need to <a href="http://www-01.ibm.com/support/docview.wss?uid=swg21573667">add them using the <span style="font-family: Courier New, Courier, monospace;">addIdMgrPropertyToEntityTypes</span> admin task</a>. For example:<br />
<br />
<span style="font-family: Courier New, Courier, monospace;">$AdminTask addIdMgrPropertyToEntityTypes { -name ssn -dataType string -entityTypeNames PersonAccount }</span><br />
<br />
Note that the <span style="font-family: Courier New, Courier, monospace;">addIdMgrPropertyToEntityTypes</span> operation has parameters (<span style="font-family: Courier New, Courier, monospace;">nsURI</span> and <span style="font-family: Courier New, Courier, monospace;">nsPrefix</span>) to specify a custom namespace for the property (to be used instead of the default <span style="font-family: Courier New, Courier, monospace;">http://www.ibm.com/websphere/wim</span> namespace). While it may seem a good idea to define custom properties in a different namespace, the available documentation is not clear about how to query such properties (they are not returned by the code shown in the infocenter document).<br />
<br />
Also note that <span style="font-family: Courier New, Courier, monospace;">AdminTask</span> doesn’t define any operation to modify or remove properties. However, this can be achieved by manipulating the <span style="font-family: Courier New, Courier, monospace;">cells/<i>{cell_name}</i>/wim/model/wimxmlextension.xml</span> document in the configuration repository.<br />
<br />
The infocenter document mentioned above shows how to invoke the <span style="font-family: Courier New, Courier, monospace;">Service#get</span> method. However, that invocation will only work if the caller has sufficient privileges to access the user information. If the code is executed inside an application, then the user has already been authenticated and the call should succeed (because VMM grants each user access to his own information). On the other hand, if the code is executed inside a login module, authentication is not yet complete and the call will fail with a CWWIM2008E error. To avoid this, it is necessary to execute the code with additional privileges. To do this, <a href="https://gist.github.com/3075970">execute the code with the identity of the server subject</a>:<br />
<br />
<span style="font-family: Courier New, Courier, monospace;">ContextManagerFactory.getInstance().runAsSystem(new PrivilegedExceptionAction&lt;Void&gt;()) {</span><br />
<span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;public Void run() {</span><br />
<span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br />
<span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return null;</span><br />
<span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;}</span><br />
<span style="font-family: Courier New, Courier, monospace;">};</span><br />
<br />
The infocenter document doesn't show how to programmatically extract the properties from the result of the <span style="font-family: Courier New, Courier, monospace;">Service#get</span> method. This is actually fairly easy, as shown in the following example:<br />
<br />
<span style="font-family: Courier New, Courier, monospace;">DataObject response = service.get(root);</span><br />
<span style="font-family: Courier New, Courier, monospace;">DataObject entity = (DataObject)response.get("entities[1]");</span><br />
<span style="font-family: Courier New, Courier, monospace;">String ssn = entity.getString("ssn");</span><br />
<br />
Note that the <span style="font-family: Courier New, Courier, monospace;">getString</span> method throws an <span style="font-family: Courier New, Courier, monospace;">IllegalArgumentException</span> if the attribute is not present.<br />
<br />
You can now use the retrieved attributes to enrich the <span style="font-family: Courier New, Courier, monospace;">Subject</span> built by the chain of login modules to make the information available to your applications.<br />
<br />
<h4>Further reading:</h4>
<br/>
<li>To get an overview of the Virtual Member Manager:
<ul>
<li><a href="ftp://ftp.software.ibm.com/pub/info/wcm/Webcast-2009-03-26-WMMtoVMM.pdf">ftp://ftp.software.ibm.com/pub/info/wcm/Webcast-2009-03-26-WMMtoVMM.pdf</a></li>
<li><a href="http://public.dhe.ibm.com/software/dw/websphere/CustomUserRepositoryFinal.pdf">http://public.dhe.ibm.com/software/dw/websphere/CustomUserRepositoryFinal.pdf</a></li>
</ul>
</li>
<li>To get more information about JAAS login modules in WebSphere: <a href="http://www.ibm.com/developerworks/websphere/techjournal/0508_benantar/0508_benantar.html">http://www.ibm.com/developerworks/websphere/techjournal/0508_benantar/0508_benantar.html</a></li>

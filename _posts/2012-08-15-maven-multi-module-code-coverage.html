---
layout: post
title: "Code coverage analysis in multi-module Maven projects"
category: tech
tags:
 - Maven
blogger: /2012/08/code-coverage-analysis-in-multi-module.html
---

<p>
When doing refactorings and other maintenance work on mature projects, <a href="http://en.wikipedia.org/wiki/Code_coverage">code coverage</a>
analysis is an invaluable tool to help ensuring that the changes have no unexpected side effects. Usually I do that using
<a href="http://cobertura.sourceforge.net/">Cobertura</a> because it's very easy to use in Maven projects (just type
<code>mvn cobertura:cobertura</code> and open the report generated under <code>target/site/cobertura</code>). One of the
shortcomings of Cobertura is its lack of support for multi-module Maven builds. That is really annoying because in many large
projects, a significant amount of code coverage for a given Maven module is actually generated by tests run in other modules.
E.g. there are many projects that have a dedicated Maven module for integration tests.
</p>
<p>
Recently I learnt about <a href="http://www.eclemma.org/jacoco/">JaCoCo</a> which is another code coverage analysis tool.
Unfortunately it has the same shortcoming as Cobertura: out of the box, it doesn't support multi-module Maven builds. There
is a <a href="https://github.com/jacoco/jacoco/issues/18">bug report</a> that contains a patch that solves this issue
(at least to some degree; see below). The patch has not been applied yet; in order to use it you will have to build a
patched version of JaCoCo manually. The patch can be applied cleanly to revision 1674 of JaCoCo trunk.
</p>
<p>
Here is the complete set of instructions to build a patched version of JaCoCo and deploy it to the local Maven repository:
</p>
<pre><code>svn co -r 1674 https://eclemma.svn.sourceforge.net/svnroot/eclemma/jacoco/trunk/jacoco
cd jacoco
curl http://sourceforge.net/apps/trac/eclemma/raw-attachment/ticket/186/jacoco-maven-aggregate.diff | patch -p0
cd org.jacoco.build
mvn clean install</code></pre>
<p>
After that you can use JaCoCo on a multi-module Maven project with the following commands:
</p>
<pre><code>mvn org.jacoco:jacoco-maven-plugin:0.5.8-SNAPSHOT:prepare-agent -Daggregate=true clean install
mvn org.jacoco:jacoco-maven-plugin:0.5.8-SNAPSHOT:report -Daggregate=true</code></pre>
<p>
There is however one important limitation: because of an issue in code added by the patch, it only works on multi-module projects
where the root POM is also the parent POM. If this is not the case, then the plugin will fail with a NullPointerException.
</p>
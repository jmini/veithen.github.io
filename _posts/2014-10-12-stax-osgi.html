---
layout: post
title: How to change the StAX implementation in an OSGi environment
category: tech
---

<p>The StAX API uses the so called <a href="http://docs.oracle.com/javase/6/docs/technotes/guides/jar/jar.html#Service%20Provider">JDK 1.3 service provider discovery</a> mechanism to locate providers of its three factory classes (<code>XMLInputFactory</code>, <code>XMLOutputFactory</code> and <code>XMLEventFactory</code>). This mechanism uses the <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/Thread.html#getContextClassLoader()">thread context class loader</a> to look up resources under <tt>META-INF/services/</tt>. Switching to a StAX implementation other than the one shipped with the JRE therefore requires deploying the JAR containing that implementation in such a way that it becomes visible to the thread context class loader.</p>

<p>In a simple J2SE application, the thread context class loader is set to the application class loader and the right way to do this is to add the JAR to the class path. In a JavaEE environment, each application (EAR) and each Web module (WAR) has its own class loader and the specification requires that the application server sets the thread context class loader to the corresponding application or module class loader before invoking a component (servlet, bean, etc.). To change the StAX implementation used by a given application or module, it is therefore enough to add the JAR to the relevant EAR or WAR.</p>

<p>Things are different in an OSGi environment because each bundle has its own class loader, but the thread context class loader is undefined. JDK 1.3 service provider discovery will therefore not be able to discover a StAX implementation deployed as a bundle. The solution to this problem is to modify the StAX API to replace the JDK 1.3 service provider discovery with an OSGi aware mechanism not relying on the thread context class loader. That modified StAX API would then be deployed as an OSGi bundle itself so that it will be used in place of the StAX API from the JRE. At least two such StAX API bundles exist: one from the <a href="http://geronimo.apache.org/">Apache Geronimo</a> project and one from <a href="http://servicemix.apache.org/">Apache ServiceMix</a>.</p>

<p>In the following we will discuss how they work, and in particular how they can be used to switch to <a href="http://woodstox.codehaus.org/">Woodstox</a> as StAX implementation. Note that the Woodstox JAR (Maven: <a href="http://repo.maven.apache.org/maven2/org/codehaus/woodstox/woodstox-core-asl/">org.codehaus.woodstox:woodstox-core-asl</a>) as well as the StAX2 API JAR (Maven: <a href="http://repo.maven.apache.org/maven2/org/codehaus/woodstox/stax2-api/">org.codehaus.woodstox:stax2-api</a>) on which it depends already have OSGi manifests and therefore can be deployed as bundles without the need to repackage them.</p>

<p>To use the StAX support from Apache Geronimo, two bundles need to be installed: the Geronimo OSGi registry (Maven: <a href="http://repo.maven.apache.org/maven2/org/apache/geronimo/specs/geronimo-osgi-registry/1.1/">org.apache.geronimo.specs:geronimo-osgi-registry:1.1</a>) and the Geronimo StAX API bundle (Maven: <a href="http://repo.maven.apache.org/maven2/org/apache/geronimo/specs/geronimo-stax-api_1.2_spec/1.2/">org.apache.geronimo.specs:geronimo-stax-api_1.2_spec:1.2</a>). The OSGi registry tracks bundles that have the <tt>SPI-Provider</tt> attribute set to <tt>true</tt> in their manifests. It scans these bundles for resources under <tt>META-INF/services/</tt>. That information is then used by the StAX API bundle to locate the StAX implementation. This means that Geronimo uses the same metadata as the JDK 1.3 service provider discovery, but requires an additional (non standard) bundle manifest attribute. The stock Woodstox bundle doesn't have this attribute and therefore will not be recognized. Instead, a repackaged version of Woodstox is required. The Geronimo project provides this kind of bundles (Maven: <a href="http://repo.maven.apache.org/maven2/org/apache/geronimo/bundles/woodstox-core-asl/">org.apache.geronimo.bundles:woodstox-core-asl</a>), albeit not for the most recent Woodstox versions.</p>

<p>The StAX support from Apache ServiceMix comes as a single bundle to deploy (Maven: <a href="http://repo.maven.apache.org/maven2/org/apache/servicemix/specs/org.apache.servicemix.specs.stax-api-1.2/2.4.0/">org.apache.servicemix.specs:org.apache.servicemix.specs.stax-api-1.2:2.4.0</a>). It scans all bundles for StAX related resources under <tt>META-INF/services/</tt>, i.e. it uses exactly the same metadata as the JDK 1.3 service provider discovery. This means that it will recognize the vanilla Woodstox bundle and no repackaging is required.</p>

<p>To summarize, the most effective way to switch to Woodstox as the StAX implementation in an OSGi environment is to deploy the following three bundles (identified by their Maven coordinates):</p>
<ul>
<li><a href="http://repo.maven.apache.org/maven2/org/apache/servicemix/specs/org.apache.servicemix.specs.stax-api-1.2/2.4.0/">org.apache.servicemix.specs:org.apache.servicemix.specs.stax-api-1.2:2.4.0</a></li>
<li><a href="http://repo.maven.apache.org/maven2/org/codehaus/woodstox/stax2-api/">org.codehaus.woodstox:stax2-api</a></li>
<li><a href="http://repo.maven.apache.org/maven2/org/codehaus/woodstox/woodstox-core-asl/">org.codehaus.woodstox:woodstox-core-asl</a></li>
</ul>
